/*
 * This is the Asteroid class and handles
 *		- Initilaising a single asteroid.
 *		- Moving / updating the asteroid.
 *		- Checking oob from bottom of screen.
 *		- Packing asteroid data into a struct for network data transfer.
 *
 * Original @author D. Green.
 *
 * © D. Green. 2021.
 */

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// INCLUDES
#include "Asteroid.h"
#include <iostream>
#include <cstdlib>

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// CONSTRUCTOR / DESTRUCTOR
Asteroid::Asteroid(sf::RenderWindow* hwnd) : window(hwnd)
{
	position = sf::Vector2f(0.0f, 0.0f);
	velocity = sf::Vector2f(0.0f, 0.0f);
	randXPos = rand() % 1180 + 50;
	randYPos = 20.0f;

	asteroidMsg = new AsteroidDataMsg;

	initAsteroid();
}

Asteroid::~Asteroid()
{
	if (asteroidMsg)
	{
		delete asteroidMsg;
		asteroidMsg = nullptr;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

AsteroidDataMsg* Asteroid::packAsteroidData(float totalGameTime, int asteroidID)
{
	asteroidMsg->asteroidID = asteroidID;
	asteroidMsg->timeSent = totalGameTime;
	asteroidMsg->x = asteroidSprite.getPosition().x;
	asteroidMsg->y = asteroidSprite.getPosition().y;

	return asteroidMsg;
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool Asteroid::update(float dt)
{
	move();
	collisionBox = sf::FloatRect(asteroidSprite.getPosition().x - size.x * 0.5f, asteroidSprite.getPosition().y - size.y * 0.5f, size.x, size.y);
	bool oob = checkScreenBounds();

	return oob;
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Asteroid::render(sf::RenderWindow* window)
{
	window->draw(asteroidSprite);
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Asteroid::initAsteroid()
{
	loadTexture();
	asteroidTexture.setSmooth(true);
	asteroidSprite.setTexture(asteroidTexture);
	size = asteroidTexture.getSize();
	asteroidSprite.setOrigin(size.x * 0.5f, size.y * 0.5f);
	asteroidSprite.setPosition(sf::Vector2f(randXPos, randYPos));
	velocity = sf::Vector2f(0.0f, 2.5f);
	collisionBox = sf::FloatRect(asteroidSprite.getPosition().x - size.x * 0.5f, asteroidSprite.getPosition().y - size.y * 0.5f, size.x, size.y);
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Asteroid::loadTexture()
{
	if (!asteroidTexture.loadFromFile("res/gfx/asteroids/asterGreySml.png"))
	{
		std::cout << "Error loading asteroid texture\n";
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool Asteroid::checkScreenBounds()
{
	// If we go out the bottom of the screen
	if (asteroidSprite.getPosition().y - size.y > window->getSize().y)
	{
		return true;
	}

	return false;
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Asteroid::move()
{
	asteroidSprite.setPosition(asteroidSprite.getPosition() + velocity);
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

sf::Sprite* Asteroid::getAsteroidSprite()
{
	return &asteroidSprite;
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

sf::FloatRect Asteroid::getCollisionBox()
{
	return collisionBox;
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Asteroid::setCollisionBox(float x, float y, float width, float height)
{
	collisionBox = sf::FloatRect(x, y, width, height);
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////